<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상반신 자세 교정 화상 채팅 서비스</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #output_canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
        }
        #message {
            position: absolute;
            left: 20px;
            top: 20px;
            font-size: 36px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .warning { color: red; }
        .praise { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <video id="input_video" style="display: none;"></video>
        <canvas id="output_canvas"></canvas>
        <div id="message"></div>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const messageElement = document.getElementById('message');

        let badPostureCount = 0;
        let goodPostureCount = 0;
        let lastMessageType = '';

        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 4});
                drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#FF0000', lineWidth: 2});

                checkPosture(results.poseLandmarks);
            }
            canvasCtx.restore();
        }

        function checkPosture(landmarks) {
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const nose = landmarks[0];

            const shoulderY = (leftShoulder.y + rightShoulder.y) / 2;
            const shoulderX = (leftShoulder.x + rightShoulder.x) / 2;

            // 목 숙임 체크
            const neckAngle = Math.abs(nose.x - shoulderX);
            // 어깨 기울기 체크
            const shoulderSlope = Math.abs(leftShoulder.y - rightShoulder.y);

            if (neckAngle > 0.1 || shoulderSlope > 0.05) {
                badPostureCount++;
                goodPostureCount = 0;
                if (badPostureCount > 30 && lastMessageType !== 'warning') { // 약 1초 동안 나쁜 자세 유지
                    showMessage("자세를 바르게 해주세요!", 'warning');
                    lastMessageType = 'warning';
                }
            } else {
                goodPostureCount++;
                if (goodPostureCount > 60 && lastMessageType === 'warning') { // 약 2초 동안 좋은 자세 유지
                    showMessage("좋은 자세입니다! 잘 하고 계세요.", 'praise');
                    lastMessageType = 'praise';
                }
                badPostureCount = 0;
            }

            console.log("Neck Angle:", neckAngle, "Shoulder Slope:", shoulderSlope);
        }

        function showMessage(text, type) {
            messageElement.textContent = text;
            messageElement.className = type;
            setTimeout(() => {
                messageElement.textContent = '';
                messageElement.className = '';
            }, 3000);
        }

        const pose = new Pose({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }});
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        pose.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });
        camera.start();

        function resizeCanvas() {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
    </script>
</body>
</html>
